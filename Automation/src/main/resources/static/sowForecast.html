<!DOCTYPE html>
<html>

<head>
<title>Forecast Form</title>
<style type="text/css">
@import
	url('https://fonts.googleapis.com/css2?family=Lato:wght@700&display=swap')
	;

body {
	margin: 0px;
	background-color: #e6e3e3;
	font-family: 'Open Sans', sans-serif;
	color: #000048;
	font-weight: 750;
	letter-spacing: 0.1px;
}

header {
	display: flex;
	font-family: 'Open Sans', sans-serif;
	font-weight: 750;
	height: 70px;
	background: #000048;
	color: #e6e3e3;
	overflow: hidden;
	letter-spacing: 0.1px;
}

a {
	color: #000048;
	text-decoration: none;
}

label {
	font-size: 15px;
}

.fixedwidth {
	width: 256px;
	font-size: 13px;
}

.fixedwidthf1 {
	width: 256px;
	font-size: 13px;
}

#main {
	font-family: 'Open Sans', sans-serif;
	width: 800px;
	height: auto;
	overflow: hidden;
	padding-bottom: 20px;
	margin-left: auto;
	margin-right: auto;
	border-radius: 5px;
	padding-left: 10px;
	padding-top: 20px;
}

#main table {
	font-family: 'Open Sans', sans-serif;
}

#main .tb, .fixedwidth, .vendorname, .cvsname, .sheetName {
	height: 28px;
	width: 250px;
	border: 1px solid #000048;
	border-radius: 3px;
	color: #000048;
	font-weight: bold;
	opacity: 0.9;
}

.required {
	color: #000048;
}

#main .tb:focus, .fixedwidth, .vendorname:focus, .cvsname:focus {
	height: 28px;
	border: 1px solid #000048;
	border-radius: 3px;
	outline: none;
}

#main .btn {
	width: 150px;
	height: 32px;
	outline: none;
	color: #f7f7f7;
	font-weight: bold;
	border: 0px solid #000048;
	text-shadow: 0px 0.5px 0.5px #fff;
	border-radius: 2px;
	font-weight: 600;
	color: #000048;
	letter-spacing: 0.5px;
	font-size: 14px;
	background-color: #f1f1f1;
	-webkit-transition: 0.1s;
	-moz-transition: 0.1s;
	transition: 0.1s;
}

#main .btn:hover {
	background-color: #000048;
	outline: none;
	border-radius: 2px;
	color: #f1f1f1;
	border: 1px solid #000048;
	-webkit-transition: 0.1s;
	-moz-transition: 0.1s;
	transition: 0.1s;
}

select {
	width: 150px;
	height: 30px;
}

input[type="range"] {
	width: 30px;
}

.screen-reader-only {
	position: absolute;
	top: -9999px;
	left: -9999px;
}

.error-message {
	color: #fd0606;
	font-size: 18px;
	text-align: right;
}

.tooltip {
	position: relative;
	display: inline-block;
	border-bottom: 1px dotted black;
}

.tooltip .tooltiptext {
	visibility: hidden;
	width: 200px;
	background-color: black;
	color: #fff;
	text-align: center;
	border-radius: 6px;
	padding: 5px 0;
	position: absolute;
	z-index: 1;
}

.tooltip:hover .tooltiptext {
	visibility: visible;
}
</style>
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>

    
    function redirectToPage() {
		var rangeInput = document.getElementById('choice');
		if (rangeInput.value == 0) {
			window.location.href = 'Amendment.html';
		} else if (rangeInput.value == 1) {
			window.location.href = 'sowForecast.html';
		}
	}
    
    
    function loadCostCenters() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://localhost:8080/api/v1.0/cost-centers');
        xhr.onload = function () {
            if (xhr.status === 200) {
                var costCenters = JSON.parse(xhr.responseText);
                var dropdown = document.getElementById('costCenter');
                console.log(costCenters);
                for (var i = 0; i < costCenters.length; i++) {
                  var option = document.createElement("option");
                  option.value = costCenters[i].code;
                  option.text = costCenters[i].code;
                  dropdown.appendChild(option);
            } 
        }
        };
        xhr.send();
    }
    
    function loadSheetNames() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://localhost:8080/api/v1.0/sheetNames');
        xhr.onload = function () {
            if (xhr.status === 200) {
                var sheetNames = JSON.parse(xhr.responseText);
                var dropdown = document.getElementById('sheetName');
                console.log(sheetNames);
                for (var i = 0; i < sheetNames.length; i++) {
                  var option = document.createElement("option");
                  option.value = sheetNames[i].sheetN;
                  option.text = sheetNames[i].sheetN;
                  dropdown.appendChild(option);
            } 
        }
        };
        xhr.send();
    }
    var selectedRoles=[];
    function addMorevendorFields() {
        var vendorTeam = Array.from(document.getElementsByClassName('vendorTeam'));
        var tr = document.createElement('tr');
        tr.setAttribute('class', 'vendorTeam');
        var td1 = document.createElement('td');
        tr.appendChild(td1);
        var td2 = document.createElement('td');
        var dropdown = document.createElement('select');
        dropdown.setAttribute('class', 'vendorIdList fixedwidth');
        
        td2.appendChild(dropdown);
        tr.appendChild(td2);
        var option = document.createElement('option');
        option.text = "Select Associate";
        option.value = "";
        dropdown.add(option);
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://localhost:8080/api/v1.0/vendors');
        xhr.onload = function () {
            if (xhr.status === 200) {
                var vendors = JSON.parse(xhr.responseText);
                console.log(vendors);
                
                for (var vendorId in vendors) {
              	  if (vendors.hasOwnProperty(vendorId)) {
              	    var vendor = vendors[vendorId];
              	    var name = vendor.name;
              	    var option = document.createElement('option');
              	    option.text = name;
              	    option.value = vendorId;
              	    option.dataset.role = vendor.role; // set data-role attribute with vendor role
              	    dropdown.add(option);
              	  }
              	}

                dropdown.addEventListener('change', function() {
                	  var selectedVendorRole = dropdown.selectedOptions[0].dataset.role;                     
                	  if (selectedVendorRole) {
                	    selectedRoles.push(selectedVendorRole);
                	  }
                	  checkVendorRoles(); // check the roles every time a selection is made
                	});



                
            } else {
                console.log('Request failed.  Returned status of ' + xhr.status);
            }
        };
        xhr.send();
        
        
        
        var td3 = document.createElement('td');
        tr.appendChild(td3);
        var td4 = document.createElement('td');
        tr.appendChild(td4);
        vendorTeam[vendorTeam.length - 1].insertAdjacentElement('afterend', tr);
    }
	
    
    function loadVendors() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://localhost:8080/api/v1.0/vendors');
        xhr.onload = function () {
            if (xhr.status === 200) {
                vendors = JSON.parse(xhr.responseText);
                console.log(vendors);
                var dropdown = document.getElementById('vendor-dropdown');
                        
                for (var vendorId in vendors) {
                	  if (vendors.hasOwnProperty(vendorId)) {
                	    var vendor = vendors[vendorId];
                	    var name = vendor.name;
                	    var option = document.createElement('option');
                	    option.text = name;
                	    option.value = vendorId;
                	    option.dataset.role = vendor.role; // set data-role attribute with vendor role
                	    dropdown.add(option);
                	  }
                	}

                	} else {
                	  console.log('Request failed.  Returned status of ' + xhr.status);
                	}
                	};
                	xhr.send();

                	var dropdown = document.getElementById('vendor-dropdown');
                	dropdown.addEventListener('change', function() {
                		  var selectedVendorRole = dropdown.selectedOptions[0].dataset.role;                     
                		  if (selectedVendorRole) {
                		    selectedRoles.push(selectedVendorRole);
                		  }
                		  checkVendorRoles(); // check the roles every time a selection is made
                		});

                	
    }


        function removevendorFields() {
            var vendorTeam = document.getElementsByClassName('vendorTeam');
            if (vendorTeam.length > 1) {
                vendorTeam[vendorTeam.length - 1].remove();
            }
        }

        function addMorecvsFields() {
            var cvsTeam = Array.from(document.getElementsByClassName('cvsTeam'));
            var tr = document.createElement('tr');
            tr.setAttribute('class', 'cvsTeam');
            var td1 = document.createElement('td');
            tr.appendChild(td1);
            var td2 = document.createElement('td');
            var dropdown = document.createElement('select');
            dropdown.setAttribute('class', 'cvsIdList fixedwidth');
            td2.appendChild(dropdown);
            tr.appendChild(td2);
            var option = document.createElement('option');
            option.text = "Select Associate";
            option.value = "";
            dropdown.add(option);
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'http://localhost:8080/api/v1.0/cvs');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var cvs = JSON.parse(xhr.responseText);
                    for (var cvsId in cvs) {
                        if (cvs.hasOwnProperty(cvsId)) {
                            var name = cvs[cvsId].name;
                            var option = document.createElement('option');
                            option.text = name;
                            option.value = cvsId;
                            dropdown.add(option);
                        }
                    }
                } else {
                    console.log('Request failed.  Returned status of ' + xhr.status);
                }
            };
            xhr.send();

            var td3 = document.createElement('td');
            tr.appendChild(td3);
            var td4 = document.createElement('td');
            tr.appendChild(td4);
            cvsTeam[cvsTeam.length - 1].insertAdjacentElement('afterend', tr);
        }



        function loadCVS() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'http://localhost:8080/api/v1.0/cvs');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var cvs = JSON.parse(xhr.responseText);
                    var dropdown = document.getElementById('cvs-dropdown');
                    for (var cvsId in cvs) {
                        if (cvs.hasOwnProperty(cvsId)) {
                            var name = cvs[cvsId].name;
                            var option = document.createElement('option');
                            option.text = name;
                            option.value = cvsId;
                            dropdown.add(option);
                        }
                    }
                } else {
                    console.log('Request failed.  Returned status of ' + xhr.status);
                }
            };
            xhr.send();
        }



        function removecvsFields() {
            var cvsTeam = document.getElementsByClassName('cvsTeam');
            if (cvsTeam.length > 1) {
                cvsTeam[cvsTeam.length - 1].remove();
            }
        }
        
        
        function checkVendorRoles() {
      	  var requiredRoles = ['Client Relationship Manager', 'Engagement Manager'];
      	  var presentRoles = [];

      	  var dropdowns = document.querySelectorAll('.vendorIdList');
      	  dropdowns.forEach(function(dropdown) {
      	    var selectedOption = dropdown.selectedOptions[0];
      	    if (selectedOption && (selectedOption.dataset.role === requiredRoles[0] || selectedOption.dataset.role === requiredRoles[1])) {
      	      presentRoles.push(selectedOption.dataset.role);
      	    }
      	  });

      	  for (var i = 0; i < requiredRoles.length; i++) {
      	    if (!presentRoles.includes(requiredRoles[i])) {
      	      selectedRoles = []; // clear the array
      	      return false;
      	    }
      	  }

      	  return true;
      	}
        
        
        function checkFile(sender, validExts) {
            var fileExt = sender.value;
            fileExt = fileExt.substring(fileExt.lastIndexOf('.'));
            if (validExts.indexOf(fileExt) < 0 && fileExt != "") {
                alert("Invalid file selected, valid files are of " + validExts.toString() + " types.");
                $(sender).val("");
                return false;
            }
            else return true;
        }
        

        function submitForm() {
            const sheetName = document.getElementById("sheetName").value;
            const costCenter = document.getElementById("costCenter").value;
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;
            const empId = document.getElementById("empId").value;
            const sowName = document.getElementById("sowName").value;
            const fileInput = document.getElementById("upload_file").value;
            const amount = document.getElementById("amount").value;


            const vendorTeam = [];
            const vendorTeamInputs = document.getElementsByClassName("vendorIdList");
            for (let i = 0; i < vendorTeamInputs.length; i++) {
                vendorTeam.push(vendorTeamInputs[i].value);
            }
            
            const cvsTeam = [];
            const cvsTeamInputs = document.getElementsByClassName("cvsIdList");
            for (let i = 0; i < cvsTeamInputs.length; i++) {
                cvsTeam.push(cvsTeamInputs[i].value);
            }

            console.log(cvsTeam)

            if (sheetName === "") {
                alert("Please select a sheet name.");
                return;
            }

            if (costCenter === "") {
                alert("Please select a cost center.");
                return;
            }

            if (startDate === "") {
                alert("Please select a start date.");
                return;
            }

            if (endDate === "") {
                alert("Please select an end date.");
                return;
            }
			
            
      
            if (vendorTeam.filter(x => x !== '').length === 0) {
            	  alert("Please select at least two vendor team details.");
            	  return;
            	}

            if (!checkVendorRoles()) {
                alert('Please select both Client Relationship Manager and Engagement Manager in vendor team.');
                return;
              }
            
            	if (cvsTeam.filter(x => x !== '').length === 0) {
            	  alert("Please select at least one CVS team detail.");
            	  return;
            	}
            	
            	if (sowName === "") {
                    alert("Please enter an Sow Name.");
                    return;
                }
            	
            	if (fileInput === '') {
            	    alert("Please select a file to upload.");
            	    return;
            	  }

            var em = empId.toString();
            if (empId === "" || em.length >= 7) {
                alert("Please enter a valid empId.");
                return;
            }
           
            document.getElementById("submitBtn").disabled = true;

            const filters = {
                sheetName,
                costCenter,
                startDate,
                endDate,
                vendorTeam,
                cvsTeam,
                empId,
                sowName,
                amount
            };

            const formData = new FormData();
            formData.append("forecast_file", document.getElementById("upload_file").files[0]);
            formData.append("filters", JSON.stringify(filters));

           
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "http://localhost:8080/api/v1.0/createWordFile", true);
            xhr.responseType = "blob";  

            xhr.onload = function (event) {
              	  if (xhr.status === 400) {
              	    alert("No data found for your input.Please try with different inputs.");
              	    return;
              	  }
              	  
              if (xhr.status === 200) {
                const xhrSF = new XMLHttpRequest();
                xhrSF.open('GET', 'http://localhost:8080/api/v1.0/sowName');
                xhrSF.onload = function (event) {
                  if (xhrSF.status === 200) {
                    var SOWName = JSON.parse(xhrSF.responseText);
                    console.log("Hiiiiiiii")
                    console.log(SOWName);
                    
                    const xhr00 = new XMLHttpRequest();
                    xhr00.open("POST", "http://localhost:8080/api/v1.0/createWordFile", true);
                    xhr00.responseType = "blob";  

                    xhr00.onload = function (event) {
                      if (xhr00.status === 200) {
                    	  alert("Submitted Successfully");
                        const blob = xhr00.response;
                        const link = document.createElement("a");
                        link.href = URL.createObjectURL(blob);
                        link.download = SOWName[0];
                        link.click();
                        
                        const xhr01 = new XMLHttpRequest();
                        xhr01.open("POST", "http://localhost:8080/api/v1.0/createExcelFile", true);
                        xhr01.responseType = "blob";

                        xhr01.onload = function (event) {
                          if (xhr01.status === 200) {
                            const blob = xhr01.response;
                            const link1 = document.createElement("a");
                            link1.href = URL.createObjectURL(blob);
                            link1.download = SOWName[1];
                            link1.click();
                            document.getElementById("myForm").reset();
                            alert("Downloaded Successfully");
                            document.getElementById("submitBtn").disabled = false;
                          }
                        };

                        xhr01.send(formData);
                      }
                      else{
                      	alert("Download Failed!!!");
                      }
                    };

                    xhr00.send(formData);
                  }
                }
                

                xhrSF.send();
              }
              
            };
            
            xhr.send(formData);

        }
        document.getElementById("submitBtn").disabled = false;
       

    </script>

</head>

<body
	onload="loadCVS(); loadVendors(); loadCostCenters(); loadSheetNames()">

	<header style="display: flex; align-items: center;">
		<img src="CTS.png" height="40" width="200" style="margin-left: 10px;">
		<h2 style="flex: 0.8; text-align: center;">Forecast Details Form</h2>
	</header>


	<form id="myForm">
		<div id="main">
			<div class=error-message>*All Fields are mandatory</div>
			<table cellspacing="2" align="center" cellpadding="8" border="0">
				<tr>
					<td></td>
					<td>
						<div>
							<label class="screen-reader-only" for="choice">SOW or
								Amendment?</label> <span aria-hidden="true">Amendment</span> <input
								type="range" max="1" id="choice" name="choice"
								onchange="redirectToPage();"> <span aria-hidden="true">SOW</span>
						</div>
					</td>
				</tr>

				<tr>
					<td align="right"><label for="sheetName">Sheet Name<label
							style="color: #fd0606">*</label>:
					</label></td>
					<!-- <td><input type="text" name="sheetName" id="sheetName" class="tb" required /></td> -->
					<td><select id="sheetName" class="fixedwidth"></select></td>
				</tr>

				<tr>
					<td align="right"><label for="costcenter">Cost center<label
							style="color: #fd0606">*</label>:
					</label></td>
					<!-- <td><input type="text" name="costcenter" id="costCenter" class="tb" required /></td> -->
					<td><select id="costCenter" class="fixedwidth"></select></td>

				</tr>

				<tr>
					<td align="right"><label for="startdate">StartDate<label
							style="color: #fd0606">*</label>:
					</label></td>
					<td><input type="date" name="startdate" id="startDate"
						class="tb fixedwidth" required /></td>
				</tr>

				<tr>
					<td align="right"><label for="enddate">EndDate<label
							style="color: #fd0606">*</label>:
					</label></td>
					<td><input type="date" name="enddate" id="endDate"
						class="tb fixedwidth" required /></td>
				</tr>

				<tr class="vendorTeam">
					<td align="right"><label for="vendorname">Vendor
							Project Team<label style="color: #fd0606">*</label>:
					</label></td>
					<td><label for="vendor-dropdown"></label> <select
						id="vendor-dropdown" class="vendorIdList fixedwidth">
							<option value="" selected>Select Associate</option>
					</select></td>


					<td><a href="#" id="add_more_vendor_fields"
						onclick="addMorevendorFields()"><i
							class="fas fa-plus fixedwidthf1"></i>+Add</a></td>
					<td><a href="#" id="remove_vendor_fields"
						onclick="removevendorFields()"><i
							class="fas fa-plus fixedwidthf1"></i>-Remove</a></td>


				</tr>

				<tr class="cvsTeam">
					<td align="right"><label for="cvsname">CVS Project
							Team<label style="color: #fd0606">*</label>:
					</label></td>
					<td><label for="cvs-dropdown"></label> <select
						id="cvs-dropdown" class="cvsIdList fixedwidth">
							<option value="" selected>Select Associate</option>
					</select></td>


					<td><a href="#" id="add_more_cvs_fields"
						onclick="addMorecvsFields()"><i
							class="fas fa-plus fixedwidthf1"></i>+Add</a></td>
					<td><a href="#" id="remove_cvs_fields"
						onclick="removecvsFields()"><i
							class="fas fa-plus fixedwidthf1"></i>-Remove</a></td>


				</tr>

				<tr>
					<td align="right"><label for="amount">Total amount per
							month:</label></td>
					<td>
						<div class="tooltip">
							<input type="number" name="amount" id="amount"
								class="tb fixedwidth" required value=0 /> <span
								class="tooltiptext">If you enter any value in this field
								will add the column in fee Table in SOW document</span>
						</div>
					</td>
				</tr>

				<tr>
					<td align="right"><label for="sowName">SOW Document
							Name<label style="color: #fd0606">*</label>:
					</label></td>
					<td><input type="text" name="sowName" id="sowName"
						class="tb fixedwidth" value="SOW_.01-CC-v1-3-feb2011" required /></td>
				</tr>

				<!--  <tr>
                        <td align="right"><label for="submitName">Submit Form Name :</label></td>
                        <td><input type="text" name="submitName" id="submitName" class="tb" required /></td>
                    </tr>
                    -->
				<tr>
					<td align="right">Select file to upload<label
						style="color: #fd0606">*</label>:
					</td>
					<td><input id="upload_file" accept=".xls,.xlsx,.csv,"
						name="forecastFile" type="file" required /></td>
				</tr>

				<tr>
					<td align="right"><label for="empid">Submitted by
							(EmpId)<label style="color: #fd0606">*</label>:
					</label></td>
					<td><input type="number" name="empid" id="empId"
						class="tb fixedwidth" required /></td>
				</tr>


				<tr>
					<td></td>
					<td>
						<button type="button" id="submitBtn" onclick="submitForm()"
							class="btn">Submit</button>

					</td>
				</tr>



			</table>
		</div>
	</form>
</body>

</html>