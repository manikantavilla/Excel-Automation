<!DOCTYPE html>
<html>

<head>
<title>Forecast Form</title>
<style type="text/css">
@import
	url('https://fonts.googleapis.com/css2?family=Jost:wght@100;300;400;700&display=swap')
	;

a {
	color: rgb(247, 242, 242);
	text-decoration: none;
	font-size: 18px;
}

body {
	margin: 0px;
	background-color: #f26724;
	color: #f9fcf5;
	font-family: Arial, Helvetica, sans-serif;
}

#main {
	width: 800px;
	height: auto;
	overflow: hidden;
	padding-bottom: 20px;
	margin-left: auto;
	margin-right: auto;
	border-radius: 5px;
	padding-left: 10px;
	margin-top: 100px;
	border-top: 3px double #f1f1f1;
	border-bottom: 3px double #f1f1f1;
	padding-top: 20px;
}

#main table {
	font-family: "Comic Sans MS", cursive;
}

#main .tb, .vendorname, .cvsname {
	height: 28px;
	width: 250px;
	border: 1px solid #f26724;
	color: #fd7838;
	font-weight: bold;
	border-left: 5px solid #f7f7f7;
	opacity: 0.9;
}

.fixedwidth {
	width: 256px;
}

#main .tb:focus, .vendorname:focus, .cvsname:focus {
	height: 28px;
	border: 1px solid #f26724;
	outline: none;
	border-left: 5px solid #f7f7f7;
}

#main .btn {
	width: 150px;
	height: 32px;
	outline: none;
	color: #f7f7f7;
	font-weight: bold;
	border: 0px solid #f26724;
	text-shadow: 0px 0.5px 0.5px #fff;
	border-radius: 2px;
	font-weight: 600;
	color: #f26724;
	letter-spacing: 1px;
	font-size: 14px;
	background-color: #f1f1f1;
	-webkit-transition: 1s;
	-moz-transition: 1s;
	transition: 1s;
}

#main .btn:hover {
	background-color: #f26724;
	outline: none;
	border-radius: 2px;
	color: #f1f1f1;
	border: 1px solid #f1f1f1;
	-webkit-transition: 1s;
	-moz-transition: 1s;
	transition: 1s;
}

select {
	width: 150px;
	height: 30px;
}

a {
	color: white;
}

input[type="range"] {
	width: 30px;
}

.screen-reader-only {
	position: absolute;
	top: -9999px;
	left: -9999px;
}
</style>
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    
    function redirectToPage() {
		var rangeInput = document.getElementById('choice');
		if (rangeInput.value == 0) {
			window.location.href = 'Amendment.html';
		} else if (rangeInput.value == 1) {
			window.location.href = 'sowForecast.html';
		}
	}
    
    function loadCostCenters() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://localhost:8080/api/v1.0/cost-centers');
        xhr.onload = function () {
            if (xhr.status === 200) {
                var costCenters = JSON.parse(xhr.responseText);
                var dropdown = document.getElementById('costCenter');
                console.log(costCenters);
                for (var i = 0; i < costCenters.length; i++) {
                  var option = document.createElement("option");
                  option.value = costCenters[i].code;
                  option.text = costCenters[i].code;
                  dropdown.appendChild(option);
            } 
        }
        };
        xhr.send();
    }
    
    function loadSheetNames() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://localhost:8080/api/v1.0/sheetNames');
        xhr.onload = function () {
            if (xhr.status === 200) {
                var sheetNames = JSON.parse(xhr.responseText);
                var dropdown = document.getElementById('sheetName');
                console.log(sheetNames);
                for (var i = 0; i < sheetNames.length; i++) {
                  var option = document.createElement("option");
                  option.value = sheetNames[i].sheetN;
                  option.text = sheetNames[i].sheetN;
                  dropdown.appendChild(option);
            } 
        }
        };
        xhr.send();
    }
		var vendorRole = [];
		var vendorName = [];
        function addMorevendorFields() {
            var vendorTeam = Array.from(document.getElementsByClassName('vendorTeam'));
            var tr = document.createElement('tr');
            tr.setAttribute('class', 'vendorTeam');
            var td1 = document.createElement('td');
            tr.appendChild(td1);
            var td2 = document.createElement('td');
            var dropdown = document.createElement('select');
            dropdown.setAttribute('class', 'vendorIdList fixedwidth');
            
            td2.appendChild(dropdown);
            tr.appendChild(td2);
            var option = document.createElement('option');
            option.text = "Select Associate";
            option.value = "";
            dropdown.add(option);
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'http://localhost:8080/api/v1.0/vendors');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var vendors = JSON.parse(xhr.responseText);
                    for (var vendorId in vendors) {
                        if (vendors.hasOwnProperty(vendorId)) {
                            var name = vendors[vendorId].name;
                            var option = document.createElement('option');
                            option.text = name;
                            option.value = vendorId;
                            dropdown.add(option);
                        }
                    }
                } else {
                    console.log('Request failed.  Returned status of ' + xhr.status);
                }
            };
            xhr.send();
            var td3 = document.createElement('td');
            tr.appendChild(td3);
            var td4 = document.createElement('td');
            tr.appendChild(td4);
            vendorTeam[vendorTeam.length - 1].insertAdjacentElement('afterend', tr);
        }

        function loadVendors() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'http://localhost:8080/api/v1.0/vendors');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var vendors = JSON.parse(xhr.responseText);
                    console.log(vendors);
                    var dropdown = document.getElementById('vendor-dropdown');
                    for (var vendorId in vendors) {
                        if (vendors.hasOwnProperty(vendorId)) {
                            var name = vendors[vendorId].name;
                            vendorName.push(vendors[vendorId].name);
                            vendorRole.push(vendors[vendorId].role);
                            var option = document.createElement('option');
                            option.text = name;
                            option.value = vendorId;
                            dropdown.add(option);
                        }
                    }
                } else {
                    console.log('Request failed.  Returned status of ' + xhr.status);
                }
            };
            xhr.send();
        }


        function removevendorFields() {
            var vendorTeam = document.getElementsByClassName('vendorTeam');
            if (vendorTeam.length > 1) {
                vendorTeam[vendorTeam.length - 1].remove();
            }
        }

        function addMorecvsFields() {
            var cvsTeam = Array.from(document.getElementsByClassName('cvsTeam'));
            var tr = document.createElement('tr');
            tr.setAttribute('class', 'cvsTeam');
            var td1 = document.createElement('td');
            tr.appendChild(td1);
            var td2 = document.createElement('td');
            var dropdown = document.createElement('select');
            dropdown.setAttribute('class', 'cvsIdList fixedwidth');
            td2.appendChild(dropdown);
            tr.appendChild(td2);
            var option = document.createElement('option');
            option.text = "Select Associate";
            option.value = "";
            dropdown.add(option);
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'http://localhost:8080/api/v1.0/cvs');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var cvs = JSON.parse(xhr.responseText);
                    for (var cvsId in cvs) {
                        if (cvs.hasOwnProperty(cvsId)) {
                            var name = cvs[cvsId].name;
                            var option = document.createElement('option');
                            option.text = name;
                            option.value = cvsId;
                            dropdown.add(option);
                        }
                    }
                } else {
                    console.log('Request failed.  Returned status of ' + xhr.status);
                }
            };
            xhr.send();

            var td3 = document.createElement('td');
            tr.appendChild(td3);
            var td4 = document.createElement('td');
            tr.appendChild(td4);
            cvsTeam[cvsTeam.length - 1].insertAdjacentElement('afterend', tr);
        }



        function loadCVS() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'http://localhost:8080/api/v1.0/cvs');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var cvs = JSON.parse(xhr.responseText);
                    var dropdown = document.getElementById('cvs-dropdown');
                    for (var cvsId in cvs) {
                        if (cvs.hasOwnProperty(cvsId)) {
                            var name = cvs[cvsId].name;
                            var option = document.createElement('option');
                            option.text = name;
                            option.value = cvsId;
                            dropdown.add(option);
                        }
                    }
                } else {
                    console.log('Request failed.  Returned status of ' + xhr.status);
                }
            };
            xhr.send();
        }



        function removecvsFields() {
            var cvsTeam = document.getElementsByClassName('cvsTeam');
            if (cvsTeam.length > 1) {
                cvsTeam[cvsTeam.length - 1].remove();
            }
        }
        

        function checkFile(sender, validExts) {
            var fileExt = sender.value;
            fileExt = fileExt.substring(fileExt.lastIndexOf('.'));
            if (validExts.indexOf(fileExt) < 0 && fileExt != "") {
                alert("Invalid file selected, valid files are of " + validExts.toString() + " types.");
                $(sender).val("");
                return false;
            }
            else return true;
        }

        function submitForm() {
            const sheetName = document.getElementById("sheetName").value;
            const costCenter = document.getElementById("costCenter").value;
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;
            const empId = document.getElementById("empId").value;
            const sowName = document.getElementById("sowName").value;
            const fileInput = document.getElementById("upload_file").value;


            const vendorTeam = [];
            const vendorTeamInputs = document.getElementsByClassName("vendorIdList");
            for (let i = 0; i < vendorTeamInputs.length; i++) {
                vendorTeam.push(vendorTeamInputs[i].value);
            }
            
            const cvsTeam = [];
            const cvsTeamInputs = document.getElementsByClassName("cvsIdList");
            for (let i = 0; i < cvsTeamInputs.length; i++) {
                cvsTeam.push(cvsTeamInputs[i].value);
            }

            console.log(cvsTeam)

            if (sheetName === "") {
                alert("Please enter a sheet name.");
                return;
            }

            if (costCenter === "") {
                alert("Please enter a cost center.");
                return;
            }

            if (startDate === "") {
                alert("Please enter a start date.");
                return;
            }

            if (endDate === "") {
                alert("Please enter an end date.");
                return;
            }
			
            
      
            if (vendorTeam.filter(x => x !== '').length === 0) {
            	  alert("Please enter at least one vendor team detail.");
            	  return;
            	}

            	if (cvsTeam.filter(x => x !== '').length === 0) {
            	  alert("Please enter at least one CVS team detail.");
            	  return;
            	}
            	
            	if (sowName === "") {
                    alert("Please enter an Sow Name.");
                    return;
                }
            	
            	if (fileInput === '') {
            	    alert("Please select a file to upload.");
            	    return;
            	  }

            
            if (empId === "") {
                alert("Please enter an empId.");
                return;
            }
           

            const filters = {
                sheetName,
                costCenter,
                startDate,
                endDate,
                vendorTeam,
                cvsTeam,
                empId,
                sowName
            };

            const formData = new FormData();
            formData.append("forecast_file", document.getElementById("upload_file").files[0]);
            formData.append("filters", JSON.stringify(filters));

           
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "http://localhost:8080/api/v1.0/createWordFile", true);
            xhr.responseType = "blob";  

            xhr.onload = function (event) {
              	  if (xhr.status === 400) {
              	    alert("No data found for your input.Please try with different inputs.");
              	    return;
              	  }
              	  
              if (xhr.status === 200) {
                const xhrSF = new XMLHttpRequest();
                xhrSF.open('GET', 'http://localhost:8080/api/v1.0/sowName');
                xhrSF.onload = function (event) {
                  if (xhrSF.status === 200) {
                    var SOWName = JSON.parse(xhrSF.responseText);
                    console.log("Hiiiiiiii")
                    console.log(SOWName);
                    
                    const xhr00 = new XMLHttpRequest();
                    xhr00.open("POST", "http://localhost:8080/api/v1.0/createWordFile", true);
                    xhr00.responseType = "blob";  

                    xhr00.onload = function (event) {
                      if (xhr00.status === 200) {
                        const blob = xhr00.response;
                        const link = document.createElement("a");
                        link.href = URL.createObjectURL(blob);
                        link.download = SOWName[0];
                        link.click();
                        
                        const xhr01 = new XMLHttpRequest();
                        xhr01.open("POST", "http://localhost:8080/api/v1.0/createExcelFile", true);
                        xhr01.responseType = "blob";

                        xhr01.onload = function (event) {
                          if (xhr01.status === 200) {
                            const blob = xhr01.response;
                            const link1 = document.createElement("a");
                            link1.href = URL.createObjectURL(blob);
                            link1.download = SOWName[1];
                            link1.click();
                            
                            alert("Submitted Successfully");
                            
                          }
                        };

                        xhr01.send(formData);
                      }
                      else{
                      	alert("Download Failed!!!");
                      }
                    };

                    xhr00.send(formData);
                  }
                }
                

                xhrSF.send();
              }
              
            };
            
            xhr.send(formData);
            document.getElementById("myForm").reset();

        }
       

    </script>

</head>

<body
	onload="loadCVS(); loadVendors(); loadCostCenters(); loadSheetNames()">

	<form id="myForm">
		<div id="main">
			<h2>
				<center>Forecast Details Form</center>
			</h2>
			<div class="login">
				<table cellspacing="2" align="center" cellpadding="8" border="0">

					<tr>
						<td></td>
						<td>
							<div>
								<label class="screen-reader-only" for="choice">SOW or
									Amendment?</label> <span aria-hidden="true">Amendment</span> <input
									type="range" max="1" id="choice" name="choice"
									onchange="redirectToPage();"> <span aria-hidden="true">SOW</span>
							</div>
						</td>
					</tr>

					<tr>
						<td align="right"><label for="sheetName">Sheet Name :</label></td>
						<!-- <td><input type="text" name="sheetName" id="sheetName" class="tb" required /></td> -->
						<td><select id="sheetName" class="fixedwidth"></select></td>
					</tr>

					<tr>
						<td align="right"><label for="costcenter">Cost center
								:</label></td>
						<!-- <td><input type="text" name="costcenter" id="costCenter" class="tb" required /></td> -->
						<td><select id="costCenter" class="fixedwidth"></select></td>

					</tr>

					<tr>
						<td align="right"><label for="startdate">StartDate :</label></td>
						<td><input type="date" name="startdate" id="startDate"
							class="tb fixedwidth" required /></td>
					</tr>

					<tr>
						<td align="right"><label for="enddate">EndDate :</label></td>
						<td><input type="date" name="enddate" id="endDate"
							class="tb fixedwidth" required /></td>
					</tr>

					<tr class="vendorTeam">
						<td align="right"><label for="vendorname">Vendor
								Project Team :</label></td>
						<td><label for="vendor-dropdown"></label> <select
							id="vendor-dropdown" class="vendorIdList fixedwidth">
								<option value="" selected>Select Associate</option>
						</select></td>


						<td><a href="#" id="add_more_vendor_fields"
							onclick="addMorevendorFields()"><i
								class="fas fa-plus fixedwidth"></i>+Add</a></td>
						<td><a href="#" id="remove_vendor_fields"
							onclick="removevendorFields()"><i
								class="fas fa-plus fixedwidth"></i>-Remove</a></td>


					</tr>

					<tr class="cvsTeam">
						<td align="right"><label for="cvsname">CVS Project
								Team :</label></td>
						<td><label for="cvs-dropdown"></label> <select
							id="cvs-dropdown" class="cvsIdList fixedwidth">
								<option value="" selected>Select Associate</option>
						</select></td>


						<td><a href="#" id="add_more_cvs_fields"
							onclick="addMorecvsFields()"><i
								class="fas fa-plus fixedwidth"></i>+Add</a></td>
						<td><a href="#" id="remove_cvs_fields"
							onclick="removecvsFields()"><i class="fas fa-plus fixedwidth"></i>-Remove</a></td>


					</tr>


					<tr>
						<td align="right"><label for="sowName">SOW Document
								Name :</label></td>
						<td><input type="text" name="sowName" id="sowName"
							class="tb fixedwidth" value="SOW_.01-CC-v1-3-feb2011" required /></td>
					</tr>

					<!--  <tr>
                        <td align="right"><label for="submitName">Submit Form Name :</label></td>
                        <td><input type="text" name="submitName" id="submitName" class="tb" required /></td>
                    </tr>
                    -->
					<tr>
						<td align="right">Select file to upload :</td>
						<td><input id="upload_file" accept=".xls,.xlsx,.csv,"
							name="forecastFile" type="file" required /></td>
					</tr>

					<tr>
						<td align="right"><label for="empid">Submitted by
								(EmpId) :</label></td>
						<td><input type="number" name="empid" id="empId"
							class="tb fixedwidth" required /></td>
					</tr>


					<tr>
						<td></td>
						<td>
							<button type="button" onclick="submitForm()" class="btn">Submit</button>

						</td>
					</tr>



				</table>
			</div>
		</div>
	</form>
</body>

</html>